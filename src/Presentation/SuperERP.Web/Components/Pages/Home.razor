@page "/"
@rendermode InteractiveServer
@using SuperERP.Web.Services
@inject ApiService ApiService

<PageTitle>Dashboard - SuperERP</PageTitle>

<div class="d-flex justify-space-between align-center mb-4">
    <MudText Typo="Typo.h4">ðŸ“Š Dashboard</MudText>
    <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Refresh" OnClick="CarregarDados">Atualizar</MudButton>
</div>

<MudGrid>
    <MudItem xs="12" sm="6" md="3">
        <MudCard Elevation="2" Class="pa-4">
            <MudCardContent>
                <div class="d-flex justify-space-between align-center">
                    <div>
                        <MudText Typo="Typo.body2" Color="Color.Default">Vendas Hoje</MudText>
                        <MudText Typo="Typo.h4" Color="Color.Primary" Class="mt-2">@vendasHoje.ToString("C2")</MudText>
                        <MudText Typo="Typo.caption" Color="Color.Success">+12% vs ontem</MudText>
                    </div>
                    <MudIcon Icon="@Icons.Material.Filled.TrendingUp" Size="Size.Large" Color="Color.Primary" />
                </div>
            </MudCardContent>
        </MudCard>
    </MudItem>
    
    <MudItem xs="12" sm="6" md="3">
        <MudCard Elevation="2" Class="pa-4">
            <MudCardContent>
                <div class="d-flex justify-space-between align-center">
                    <div>
                        <MudText Typo="Typo.body2" Color="Color.Default">Clientes Ativos</MudText>
                        <MudText Typo="Typo.h4" Color="Color.Success" Class="mt-2">@totalClientes</MudText>
                        <MudText Typo="Typo.caption" Color="Color.Success">+5 este mÃªs</MudText>
                    </div>
                    <MudIcon Icon="@Icons.Material.Filled.People" Size="Size.Large" Color="Color.Success" />
                </div>
            </MudCardContent>
        </MudCard>
    </MudItem>
    
    <MudItem xs="12" sm="6" md="3">
        <MudCard Elevation="2" Class="pa-4">
            <MudCardContent>
                <div class="d-flex justify-space-between align-center">
                    <div>
                        <MudText Typo="Typo.body2" Color="Color.Default">Produtos</MudText>
                        <MudText Typo="Typo.h4" Color="Color.Info" Class="mt-2">@totalProdutos</MudText>
                        <MudText Typo="Typo.caption" Color="Color.Default">Em estoque</MudText>
                    </div>
                    <MudIcon Icon="@Icons.Material.Filled.Inventory" Size="Size.Large" Color="Color.Info" />
                </div>
            </MudCardContent>
        </MudCard>
    </MudItem>
    
    <MudItem xs="12" sm="6" md="3">
        <MudCard Elevation="2" Class="pa-4">
            <MudCardContent>
                <div class="d-flex justify-space-between align-center">
                    <div>
                        <MudText Typo="Typo.body2" Color="Color.Default">A Receber</MudText>
                        <MudText Typo="Typo.h4" Color="Color.Warning" Class="mt-2">@contasReceber.ToString("C2")</MudText>
                        <MudText Typo="Typo.caption" Color="Color.Warning">Vence em 30 dias</MudText>
                    </div>
                    <MudIcon Icon="@Icons.Material.Filled.AttachMoney" Size="Size.Large" Color="Color.Warning" />
                </div>
            </MudCardContent>
        </MudCard>
    </MudItem>
</MudGrid>

<MudGrid Class="mt-4">
    <MudItem xs="12" md="8">
        <MudCard Elevation="2">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">Vendas dos Ãšltimos 7 Dias</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <MudText Typo="Typo.body1">GrÃ¡fico de vendas dos Ãºltimos 7 dias</MudText>
                <div style="margin-top: 20px;">
                    @foreach (var venda in vendasSemana)
                    {
                        <div style="margin-bottom: 10px;">
                            <MudText>@venda.Dia: @venda.Valor.ToString("C2")</MudText>
                            <MudProgressLinear Color="Color.Primary" Value="@((double)venda.Valor / 3500 * 100)" />
                        </div>
                    }
                </div>
            </MudCardContent>
        </MudCard>
    </MudItem>
    
    <MudItem xs="12" md="4">
        <MudCard Elevation="2">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">Atividades Recentes</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                @foreach (var atividade in atividades)
                {
                    <MudText Typo="Typo.body2" Class="mb-2">
                        <MudIcon Icon="@Icons.Material.Filled.Circle" Size="Size.Small" Color="Color.Primary" />
                        @atividade
                    </MudText>
                }
            </MudCardContent>
        </MudCard>
    </MudItem>
</MudGrid>

@code {
    private decimal vendasHoje = 0;
    private int totalClientes = 0;
    private int totalProdutos = 0;
    private decimal contasReceber = 0;
    private List<VendaDia> vendasSemana = new();
    private List<string> atividades = new();

    protected override async Task OnInitializedAsync()
    {
        await CarregarDados();
    }

    private async Task CarregarDados()
    {
        try
        {
            var metricas = await ApiService.GetAsync<MetricasResponse>("api/v1/dashboard/metricas");
            
            if (metricas != null)
            {
                totalClientes = metricas.TotalClientes;
                totalProdutos = metricas.TotalProdutos;
                vendasHoje = metricas.ValorTotalVendas;
                contasReceber = 15000.00m;
            }
        }
        catch { }
        
        if (totalClientes == 0)
        {
            vendasHoje = 2500.00m;
            contasReceber = 15000.00m;
        }
        
        vendasSemana = new List<VendaDia>
        {
            new() { Dia = "Seg", Valor = 1200 },
            new() { Dia = "Ter", Valor = 1800 },
            new() { Dia = "Qua", Valor = 2100 },
            new() { Dia = "Qui", Valor = 1500 },
            new() { Dia = "Sex", Valor = 2500 },
            new() { Dia = "SÃ¡b", Valor = 3200 },
            new() { Dia = "Dom", Valor = 1900 }
        };
        
        atividades = new List<string>
        {
            "Nova venda registrada",
            "Cliente cadastrado",
            "Produto atualizado",
            "Pagamento recebido"
        };
    }

    class VendaDia
    {
        public string Dia { get; set; } = string.Empty;
        public decimal Valor { get; set; }
    }

    class MetricasResponse
    {
        public int TotalClientes { get; set; }
        public int TotalProdutos { get; set; }
        public int TotalVendas { get; set; }
        public int VendasHoje { get; set; }
        public decimal ValorTotalVendas { get; set; }
        public decimal TicketMedio { get; set; }
    }
}
