@page "/"
@rendermode InteractiveServer
@using ApexCharts
@using SuperERP.Web.Services
@inject ApiService ApiService

<PageTitle>Dashboard - SuperERP</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">Dashboard</MudText>

<MudGrid>
    <MudItem xs="12" sm="6" md="3">
        <MudCard Elevation="2">
            <MudCardContent>
                <MudText Typo="Typo.h6">Vendas Hoje</MudText>
                <MudText Typo="Typo.h3" Color="Color.Primary">@vendasHoje.ToString("C2")</MudText>
            </MudCardContent>
        </MudCard>
    </MudItem>
    
    <MudItem xs="12" sm="6" md="3">
        <MudCard Elevation="2">
            <MudCardContent>
                <MudText Typo="Typo.h6">Clientes</MudText>
                <MudText Typo="Typo.h3" Color="Color.Success">@totalClientes</MudText>
            </MudCardContent>
        </MudCard>
    </MudItem>
    
    <MudItem xs="12" sm="6" md="3">
        <MudCard Elevation="2">
            <MudCardContent>
                <MudText Typo="Typo.h6">Produtos</MudText>
                <MudText Typo="Typo.h3" Color="Color.Info">@totalProdutos</MudText>
            </MudCardContent>
        </MudCard>
    </MudItem>
    
    <MudItem xs="12" sm="6" md="3">
        <MudCard Elevation="2">
            <MudCardContent>
                <MudText Typo="Typo.h6">Contas a Receber</MudText>
                <MudText Typo="Typo.h3" Color="Color.Warning">@contasReceber.ToString("C2")</MudText>
            </MudCardContent>
        </MudCard>
    </MudItem>
</MudGrid>

<MudGrid Class="mt-4">
    <MudItem xs="12" md="8">
        <MudCard Elevation="2">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">Vendas dos Últimos 7 Dias</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <ApexChart TItem="VendaDia" Title="Vendas">
                    <ApexPointSeries TItem="VendaDia"
                                     Items="vendasSemana"
                                     Name="Vendas"
                                     SeriesType="SeriesType.Bar"
                                     XValue="@(e => e.Dia)"
                                     YValue="@(e => (decimal)e.Valor)" />
                </ApexChart>
            </MudCardContent>
        </MudCard>
    </MudItem>
    
    <MudItem xs="12" md="4">
        <MudCard Elevation="2">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">Atividades Recentes</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                @foreach (var atividade in atividades)
                {
                    <MudText Typo="Typo.body2" Class="mb-2">
                        <MudIcon Icon="@Icons.Material.Filled.Circle" Size="Size.Small" Color="Color.Primary" />
                        @atividade
                    </MudText>
                }
            </MudCardContent>
        </MudCard>
    </MudItem>
</MudGrid>

@code {
    private decimal vendasHoje = 0;
    private int totalClientes = 0;
    private int totalProdutos = 0;
    private decimal contasReceber = 0;
    private List<VendaDia> vendasSemana = new();
    private List<string> atividades = new();

    protected override async Task OnInitializedAsync()
    {
        await CarregarDados();
    }

    private async Task CarregarDados()
    {
        try
        {
            var metricas = await ApiService.GetAsync<MetricasResponse>("api/v1/dashboard/metricas");
            
            if (metricas != null)
            {
                totalClientes = metricas.TotalClientes;
                totalProdutos = metricas.TotalProdutos;
                vendasHoje = metricas.ValorTotalVendas;
                contasReceber = 15000.00m;
            }
        }
        catch { }
        
        if (totalClientes == 0)
        {
            vendasHoje = 2500.00m;
            contasReceber = 15000.00m;
        }
        
        vendasSemana = new List<VendaDia>
        {
            new() { Dia = "Seg", Valor = 1200 },
            new() { Dia = "Ter", Valor = 1800 },
            new() { Dia = "Qua", Valor = 2100 },
            new() { Dia = "Qui", Valor = 1500 },
            new() { Dia = "Sex", Valor = 2500 },
            new() { Dia = "Sáb", Valor = 3200 },
            new() { Dia = "Dom", Valor = 1900 }
        };
        
        atividades = new List<string>
        {
            "Nova venda registrada",
            "Cliente cadastrado",
            "Produto atualizado",
            "Pagamento recebido"
        };
    }

    class VendaDia
    {
        public string Dia { get; set; } = string.Empty;
        public decimal Valor { get; set; }
    }

    class MetricasResponse
    {
        public int TotalClientes { get; set; }
        public int TotalProdutos { get; set; }
        public int TotalVendas { get; set; }
        public int VendasHoje { get; set; }
        public decimal ValorTotalVendas { get; set; }
        public decimal TicketMedio { get; set; }
    }
}
