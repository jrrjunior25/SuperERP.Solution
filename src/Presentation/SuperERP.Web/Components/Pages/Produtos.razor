@page "/produtos"
@using SuperERP.Application.Dtos
@using SuperERP.Application.Interfaces
@inject IProdutoAppService ProdutoService
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<PageTitle>Produtos - SuperERP</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">Produtos</MudText>

<MudCard>
    <MudCardContent>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@(() => OpenDialog(null))" StartIcon="@Icons.Material.Filled.Add">
            Novo Produto
        </MudButton>
        
        <MudTable Items="@_produtos" Class="mt-4" Loading="@_loading" Hover="true" Breakpoint="Breakpoint.Sm">
            <HeaderContent>
                <MudTh>SKU</MudTh>
                <MudTh>Nome</MudTh>
                <MudTh>Preço Venda</MudTh>
                <MudTh>Estoque</MudTh>
                <MudTh>Ações</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="SKU">@context.Sku</MudTd>
                <MudTd DataLabel="Nome">@context.Nome</MudTd>
                <MudTd DataLabel="Preço">@context.PrecoVenda.ToString("C")</MudTd>
                <MudTd DataLabel="Estoque">@context.EstoqueAtual</MudTd>
                <MudTd DataLabel="Ações">
                    <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" Color="Color.Primary" OnClick="@(() => OpenDialog(context))" />
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error" OnClick="@(() => OnDelete(context.Id))" />
                </MudTd>
            </RowTemplate>
        </MudTable>
    </MudCardContent>
</MudCard>

@code {
    private IEnumerable<ProdutoDto> _produtos = new List<ProdutoDto>();
    private bool _loading = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadProducts();
    }

    private async Task LoadProducts()
    {
        _loading = true;
        try
        {
            _produtos = await ProdutoService.GetAll();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao carregar produtos: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task OpenDialog(ProdutoDto? produto)
    {
        var parameters = new DialogParameters();
        if (produto != null)
        {
            parameters.Add("Produto", produto);
        }

        var dialog = DialogService.Show<ProdutoDialog>(produto == null ? "Novo Produto" : "Editar Produto", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadProducts();
        }
    }

    private async Task OnDelete(Guid id)
    {
        var parameters = new DialogParameters
        {
            { "ContentText", "Tem certeza que deseja excluir este produto?" },
            { "ButtonText", "Excluir" },
            { "Color", Color.Error }
        };

        var dialog = DialogService.Show<ConfirmationDialog>("Confirmar Exclusão", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            try
            {
                await ProdutoService.Remove(id);
                Snackbar.Add("Produto excluído com sucesso!", Severity.Success);
                await LoadProducts();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Erro ao excluir produto: {ex.Message}", Severity.Error);
            }
        }
    }
}
