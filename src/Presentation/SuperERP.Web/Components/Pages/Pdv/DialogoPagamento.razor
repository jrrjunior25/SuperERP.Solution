@using SuperERP.PDV.Domain.Enums
@using SuperERP.PDV.Application.Dtos
@inject ICaixaAppService CaixaService
@inject ISnackbar Snackbar

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">Registrar Pagamento</MudText>
    </TitleContent>
    <DialogContent>
        <MudGrid>
            <MudItem xs="12">
                <MudText Typo="Typo.h5">Total da Venda: @Venda.ValorTotal.ToString("C")</MudText>
                <MudText Typo="Typo.h6" Color="Color.Success">Valor Pago: @Venda.ValorPago.ToString("C")</MudText>
                <MudText Typo="Typo.h6" Color="Color.Warning">Pendente: @Venda.ValorPendente.ToString("C")</MudText>
            </MudItem>
            <MudItem xs="12" md="6">
                <MudSelect @bind-Value="_formaPagamento" Label="Forma de Pagamento" Variant="Variant.Outlined">
                    @foreach (FormaPagamento forma in Enum.GetValues(typeof(FormaPagamento)))
                    {
                        <MudSelectItem Value="forma">@forma.ToString()</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" md="6">
                <MudNumericField @bind-Value="_valorPagamento" Label="Valor a Pagar" Variant="Variant.Outlined" Adornment="Adornment.Start" AdornmentText="R$" />
            </MudItem>
            <MudItem xs="12">
                <MudButton OnClick="AdicionarPagamento" Variant="Variant.Filled" Color="Color.Primary" Disabled="@(_valorPagamento <= 0)">
                    Adicionar Pagamento
                </MudButton>
            </MudItem>
        </MudGrid>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancelar">Cancelar</MudButton>
        <MudButton Color="Color.Success" OnClick="Concluir" Disabled="@(Venda.ValorPendente > 0)">Concluir Venda</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; }
    [Parameter] public PdvVendaDto Venda { get; set; }

    private FormaPagamento _formaPagamento = FormaPagamento.Dinheiro;
    private decimal _valorPagamento;

    protected override void OnParametersSet()
    {
        // Sugere o valor pendente como o valor do pagamento inicial
        _valorPagamento = Venda.ValorPendente;
    }

    private async Task AdicionarPagamento()
    {
        try
        {
            var dto = new RegistrarPagamentoDto
            {
                PdvVendaId = Venda.Id,
                FormaPagamento = _formaPagamento,
                Valor = _valorPagamento
            };

            var vendaAtualizada = await CaixaService.RegistrarPagamento(dto);
            Venda = vendaAtualizada; // Atualiza o estado da venda com o novo pagamento

            _valorPagamento = Venda.ValorPendente; // Reseta o campo para o valor restante
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao adicionar pagamento: {ex.Message}", Severity.Error);
        }
    }

    private void Cancelar() => MudDialog.Cancel();
    private void Concluir() => MudDialog.Close(DialogResult.Ok(Venda));
}
