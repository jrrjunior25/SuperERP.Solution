@page "/pdv/caixa"
@using SuperERP.Application.Dtos
@using SuperERP.Application.Interfaces
@using SuperERP.PDV.Application.Dtos
@using SuperERP.PDV.Domain.Interfaces
@inject ICaixaAppService CaixaService
@inject IProdutoAppService ProdutoService
@inject ICaixaRepository CaixaRepository
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<div class="d-flex justify-space-between align-center mb-4">
    <MudText Typo="Typo.h3">PDV - Ponto de Venda</MudText>
    @if (_sessaoAberta != null)
    {
        <MudButton Variant="Variant.Outlined" Color="Color.Error" OnClick="AbrirDialogoFechamento">Fechar Caixa</MudButton>
    }
</div>

@if (_loading)
{
    <MudProgressCircular Indeterminate="true" />
}
else if (_sessaoAberta == null)
{
    <MudPaper Class="pa-4">
        <MudText Typo="Typo.h5">Nenhuma sessão de caixa aberta.</MudText>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="AbrirDialogoAbertura" Class="mt-4" Disabled="@(_caixaPrincipal == null)">
            Abrir Caixa
        </MudButton>
        @if (_caixaPrincipal == null)
        {
            <MudText Color="Color.Error" Class="mt-2">Nenhum caixa encontrado. Configure um caixa antes de iniciar.</MudText>
        }
    </MudPaper>
}
else
{
    <MudGrid>
        <MudItem xs="12" md="7">
            <MudPaper Class="pa-4" Style="height: 100%;">
                <MudText Typo="Typo.h6">Itens da Venda</MudText>
                <MudTable Items="_itensVenda" Hover="true" Striped="true" Class="mt-4">
                    <HeaderContent>
                        <MudTh>Produto</MudTh>
                        <MudTh>Qtd.</MudTh>
                        <MudTh>Valor Un.</MudTh>
                        <MudTh>Subtotal</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Produto">@GetProductName(context.ProdutoId)</MudTd>
                        <MudTd DataLabel="Qtd.">@context.Quantidade</MudTd>
                        <MudTd DataLabel="Valor Un.">@context.ValorUnitario.ToString("C")</MudTd>
                        <MudTd DataLabel="Subtotal">@((context.Quantidade * context.ValorUnitario).ToString("C"))</MudTd>
                    </RowTemplate>
                </MudTable>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" md="5">
            <MudPaper Class="pa-4">
                <MudText Typo="Typo.h6">Lançar Produto</MudText>

                <MudAutocomplete T="ProdutoDto" Label="Buscar produto" @bind-Value="_produtoSelecionado"
                                 SearchFunc="@SearchProducts" ToStringFunc="@(e => e?.Nome ?? string.Empty)"
                                 Variant="Variant.Outlined" Class="mt-4" />

                <MudNumericField @bind-Value="_quantidade" Label="Quantidade" Variant="Variant.Outlined" Class="mt-2" Min="1" />

                <MudButton Variant="Variant.Filled" Color="Color.Secondary" OnClick="AdicionarItem" Class="mt-4" Disabled="@(_produtoSelecionado == null)">
                    Adicionar Item
                </MudButton>

                <MudDivider Class="my-4" />

                <MudText Typo="Typo.h5">Total: @_totalVenda.ToString("C")</MudText>
                <MudButton Variant="Variant.Filled" Color="Color.Success" OnClick="ProcessarPagamento" Disabled="@(!_itensVenda.Any())" Class="mt-4">
                    Ir para Pagamento
                </MudButton>
            </MudPaper>
        </MudItem>
    </MudGrid>
}

@code {
    private bool _loading = true;
    private SuperERP.PDV.Domain.Entities.Caixa? _caixaPrincipal;
    private SessaoCaixaDto? _sessaoAberta;
    private List<ItemVendaDto> _itensVenda = new();
    private decimal _totalVenda = 0;

    private ProdutoDto? _produtoSelecionado;
    private decimal _quantidade = 1;

    private Dictionary<Guid, string> _productNameCache = new();


    protected override async Task OnInitializedAsync()
    {
        var caixas = await CaixaRepository.GetAll();
        _caixaPrincipal = caixas.FirstOrDefault(c => c.Nome == "Caixa Principal");
        _loading = false;
    }

    private async Task AbrirDialogoFechamento()
    {
        var parameters = new DialogParameters { ["SessaoCaixaId"] = _sessaoAberta!.Id };
        var dialog = DialogService.Show<DialogoFechamentoCaixa>("Fechar Sessão de Caixa", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            _sessaoAberta = null;
            _itensVenda.Clear();
            _productNameCache.Clear();
            CalcularTotal();
            StateHasChanged();
            Snackbar.Add("Sessão de caixa fechada com sucesso!", Severity.Info);
        }
    }

    private string GetProductName(Guid id)
    {
        return _productNameCache.TryGetValue(id, out var name) ? name : "Produto não encontrado";
    }

    private async Task<IEnumerable<ProdutoDto>> SearchProducts(string value)
    {
        if (string.IsNullOrEmpty(value))
            return new List<ProdutoDto>();

        return await ProdutoService.SearchByName(value);
    }

    private async Task AbrirDialogoAbertura()
    {
        var parameters = new DialogParameters { ["CaixaId"] = _caixaPrincipal!.Id };
        var dialog = DialogService.Show<DialogoAberturaCaixa>("Abrir Sessão de Caixa", parameters);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is SessaoCaixaDto novaSessao)
        {
            _sessaoAberta = novaSessao;
            StateHasChanged();
        }
    }

    private void AdicionarItem()
    {
        if (_produtoSelecionado != null && _quantidade > 0)
        {
            _itensVenda.Add(new ItemVendaDto
            {
                ProdutoId = _produtoSelecionado.Id,
                Quantidade = _quantidade,
                ValorUnitario = _produtoSelecionado.PrecoVenda
            });

            if (!_productNameCache.ContainsKey(_produtoSelecionado.Id))
            {
                _productNameCache.Add(_produtoSelecionado.Id, _produtoSelecionado.Nome);
            }

            _produtoSelecionado = null;
            _quantidade = 1;
            CalcularTotal();
            StateHasChanged(); // Forçar a UI a atualizar
        }
    }

    private void CalcularTotal()
    {
        _totalVenda = _itensVenda.Sum(i => i.Quantidade * i.ValorUnitario);
    }

    private async Task ProcessarPagamento()
    {
        try
        {
            var dto = new RegistrarVendaDto
            {
                SessaoCaixaId = _sessaoAberta!.Id,
                Itens = _itensVenda
            };
            var vendaEmAberto = await CaixaService.RegistrarVenda(dto);

            var dialogParameters = new DialogParameters { ["Venda"] = vendaEmAberto };
            var dialog = DialogService.Show<DialogoPagamento>("Processar Pagamento", dialogParameters);
            var result = await dialog.Result;

            if (!result.Canceled)
            {
                Snackbar.Add($"Venda #{vendaEmAberto.Id.ToString().Substring(0, 4)} paga com sucesso!", Severity.Success);
                _itensVenda.Clear();
                _productNameCache.Clear();
                CalcularTotal();
                StateHasChanged();
            }
            else
            {
                Snackbar.Add("Pagamento cancelado.", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao iniciar processo de pagamento: {ex.Message}", Severity.Error);
        }
    }
}
