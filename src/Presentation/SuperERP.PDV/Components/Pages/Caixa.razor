@page "/caixa"
@using SuperERP.PDV.Services
@using SuperERP.PDV.Models
@inject AuthService AuthService
@inject CaixaService CaixaService
@inject NavigationManager Navigation
@implements IDisposable

<div class="caixa-container">
    <div class="caixa-header">
        <h2>üí∞ Controle de Caixa</h2>
        <div class="header-actions">
            <button class="btn btn-secondary" @onclick='() => Navigation.NavigateTo("/venda")'>üõí Vendas</button>
            <button class="btn btn-danger" @onclick="Sair">üö™ Sair</button>
        </div>
    </div>

    <div class="caixa-content">
        @if (CaixaService.CaixaAtual == null || !CaixaService.CaixaAtual.Aberto)
        {
            <div class="caixa-card">
                <h3>Abrir Caixa</h3>
                <p>Informe o valor inicial do caixa</p>

                <div class="form-group">
                    <label>Valor Inicial</label>
                    <input type="number" @bind="valorInicial" class="form-control" step="0.01" />
                </div>

                <button class="btn btn-success btn-block" @onclick="AbrirCaixa" disabled="@processando">
                    @if (processando)
                    {
                        <span>Abrindo...</span>
                    }
                    else
                    {
                        <span>‚úÖ Abrir Caixa</span>
                    }
                </button>

                @if (!string.IsNullOrEmpty(mensagemErro))
                {
                    <div class="alert alert-danger">@mensagemErro</div>
                }
            </div>
        }
        else
        {
            <div class="caixa-info-card">
                <div class="info-row">
                    <span>Operador:</span>
                    <strong>@CaixaService.CaixaAtual.Operador</strong>
                </div>
                <div class="info-row">
                    <span>Abertura:</span>
                    <strong>@CaixaService.CaixaAtual.DataAbertura.ToString("dd/MM/yyyy HH:mm")</strong>
                </div>
                <div class="info-row">
                    <span>Valor Inicial:</span>
                    <strong class="valor-positivo">R$ @CaixaService.CaixaAtual.ValorInicial.ToString("N2")</strong>
                </div>
                <div class="info-row">
                    <span>Valor Atual:</span>
                    <strong class="valor-destaque">R$ @CaixaService.CaixaAtual.ValorFinal.ToString("N2")</strong>
                </div>
            </div>

            <div class="movimentos-section">
                <h3>Movimentos do Caixa</h3>
                
                <div class="movimento-buttons">
                    <button class="btn btn-success" @onclick='() => MostrarModal("Suprimento")'>‚ûï Suprimento</button>
                    <button class="btn btn-warning" @onclick='() => MostrarModal("Sangria")'>‚ûñ Sangria</button>
                </div>

                <div class="movimentos-lista">
                    @if (!movimentos.Any())
                    {
                        <p class="text-center">Nenhum movimento registrado</p>
                    }
                    else
                    {
                        @foreach (var mov in movimentos)
                        {
                            <div class="movimento-item @mov.Tipo.ToLower()">
                                <div class="movimento-info">
                                    <strong>@mov.Tipo</strong>
                                    <small>@mov.Data.ToString("dd/MM/yyyy HH:mm")</small>
                                    <p>@mov.Descricao</p>
                                </div>
                                <div class="movimento-valor @(mov.Tipo == "Entrada" || mov.Tipo == "Suprimento" ? "positivo" : "negativo")">
                                    @(mov.Tipo == "Entrada" || mov.Tipo == "Suprimento" ? "+" : "-")R$ @mov.Valor.ToString("N2")
                                </div>
                            </div>
                        }
                    }
                </div>
            </div>

            <div class="fechar-caixa-section">
                <button class="btn btn-danger btn-block btn-lg" @onclick='() => MostrarModal("Fechar")'>
                    üîí Fechar Caixa
                </button>
            </div>
        }
    </div>

    @if (mostrarModal)
    {
        <div class="modal-overlay" @onclick="FecharModal">
            <div class="modal-box" @onclick:stopPropagation>
                <h3>@tituloModal</h3>

                @if (tipoModal == "Fechar")
                {
                    <div class="form-group">
                        <label>Valor Final em Caixa</label>
                        <input type="number" @bind="valorModal" class="form-control" step="0.01" />
                    </div>
                    <p>Valor esperado: <strong>R$ @CaixaService.CaixaAtual?.ValorFinal.ToString("N2")</strong></p>
                    @if (valorModal != CaixaService.CaixaAtual?.ValorFinal)
                    {
                        <p class="text-warning">‚ö†Ô∏è Diferen√ßa: R$ @((valorModal - (CaixaService.CaixaAtual?.ValorFinal ?? 0)).ToString("N2"))</p>
                    }
                }
                else
                {
                    <div class="form-group">
                        <label>Valor</label>
                        <input type="number" @bind="valorModal" class="form-control" step="0.01" />
                    </div>
                    <div class="form-group">
                        <label>Descri√ß√£o</label>
                        <input type="text" @bind="descricaoModal" class="form-control" />
                    </div>
                }

                <div class="modal-actions">
                    <button class="btn btn-secondary" @onclick="FecharModal">Cancelar</button>
                    <button class="btn btn-primary" @onclick="ConfirmarModal" disabled="@processando">
                        @if (processando)
                        {
                            <span>Processando...</span>
                        }
                        else
                        {
                            <span>Confirmar</span>
                        }
                    </button>
                </div>

                @if (!string.IsNullOrEmpty(mensagemErro))
                {
                    <div class="alert alert-danger">@mensagemErro</div>
                }
            </div>
        </div>
    }
</div>

<style>
    .caixa-container {
        min-height: 100vh;
        background: #f5f5f5;
    }

    .caixa-header {
        background: white;
        padding: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .header-actions {
        display: flex;
        gap: 10px;
    }

    .caixa-content {
        max-width: 800px;
        margin: 40px auto;
        padding: 20px;
    }

    .caixa-card, .caixa-info-card {
        background: white;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }

    .caixa-card h3 {
        margin-bottom: 10px;
    }

    .info-row {
        display: flex;
        justify-content: space-between;
        padding: 15px 0;
        border-bottom: 1px solid #eee;
    }

    .info-row:last-child {
        border-bottom: none;
    }

    .valor-positivo {
        color: #28a745;
    }

    .valor-destaque {
        color: #007bff;
        font-size: 1.5rem;
    }

    .movimentos-section {
        background: white;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }

    .movimento-buttons {
        display: flex;
        gap: 10px;
        margin: 20px 0;
    }

    .movimentos-lista {
        max-height: 400px;
        overflow-y: auto;
    }

    .movimento-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        border-left: 4px solid #ddd;
        margin-bottom: 10px;
        background: #f8f9fa;
        border-radius: 5px;
    }

    .movimento-item.entrada, .movimento-item.suprimento {
        border-left-color: #28a745;
    }

    .movimento-item.saida, .movimento-item.sangria {
        border-left-color: #dc3545;
    }

    .movimento-info strong {
        display: block;
        margin-bottom: 5px;
    }

    .movimento-info small {
        color: #666;
    }

    .movimento-valor {
        font-size: 1.3rem;
        font-weight: bold;
    }

    .movimento-valor.positivo {
        color: #28a745;
    }

    .movimento-valor.negativo {
        color: #dc3545;
    }

    .fechar-caixa-section {
        margin-top: 20px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
    }

    .form-control {
        width: 100%;
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 16px;
    }

    .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
    }

    .btn-primary { background: #007bff; color: white; }
    .btn-secondary { background: #6c757d; color: white; }
    .btn-success { background: #28a745; color: white; }
    .btn-warning { background: #ffc107; color: #333; }
    .btn-danger { background: #dc3545; color: white; }
    .btn-block { width: 100%; }
    .btn-lg { padding: 20px; font-size: 1.2rem; }

    .btn:hover:not(:disabled) {
        opacity: 0.9;
        transform: translateY(-2px);
    }

    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .alert {
        padding: 12px;
        border-radius: 8px;
        margin-top: 15px;
    }

    .alert-danger {
        background-color: #fee;
        color: #c33;
        border: 1px solid #fcc;
    }

    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    .modal-box {
        background: white;
        padding: 30px;
        border-radius: 15px;
        min-width: 400px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }

    .modal-actions {
        display: flex;
        gap: 10px;
        margin-top: 20px;
    }

    .text-center {
        text-align: center;
    }

    .text-warning {
        color: #ffc107;
        font-weight: bold;
    }
</style>

@code {
    private decimal valorInicial = 100;
    private decimal valorModal = 0;
    private string descricaoModal = "";
    private bool processando = false;
    private string mensagemErro = "";
    private bool mostrarModal = false;
    private string tipoModal = "";
    private string tituloModal = "";
    private List<MovimentoCaixaLocal> movimentos = new();

    protected override async Task OnInitializedAsync()
    {
        if (!AuthService.IsAuthenticated)
        {
            Navigation.NavigateTo("/", true);
            return;
        }

        await CaixaService.CarregarCaixaAbertoAsync();
        CaixaService.OnCaixaChanged += OnCaixaChanged;

        if (CaixaService.CaixaAtual != null)
        {
            await CarregarMovimentos();
        }
    }

    private async void OnCaixaChanged()
    {
        await CarregarMovimentos();
        await InvokeAsync(StateHasChanged);
    }

    private async Task CarregarMovimentos()
    {
        movimentos = await CaixaService.ObterMovimentosAsync();
    }

    private async Task AbrirCaixa()
    {
        mensagemErro = "";
        processando = true;

        try
        {
            var sucesso = await CaixaService.AbrirCaixaAsync(valorInicial, AuthService.UserName ?? "Operador");

            if (sucesso)
            {
                Navigation.NavigateTo("/venda");
            }
            else
            {
                mensagemErro = "J√° existe um caixa aberto";
            }
        }
        finally
        {
            processando = false;
        }
    }

    private void MostrarModal(string tipo)
    {
        tipoModal = tipo;
        valorModal = tipo == "Fechar" ? (CaixaService.CaixaAtual?.ValorFinal ?? 0) : 0;
        descricaoModal = "";
        mensagemErro = "";
        
        tituloModal = tipo switch
        {
            "Suprimento" => "‚ûï Registrar Suprimento",
            "Sangria" => "‚ûñ Registrar Sangria",
            "Fechar" => "üîí Fechar Caixa",
            _ => ""
        };

        mostrarModal = true;
    }

    private void FecharModal()
    {
        mostrarModal = false;
    }

    private async Task ConfirmarModal()
    {
        mensagemErro = "";
        processando = true;

        try
        {
            if (tipoModal == "Fechar")
            {
                var sucesso = await CaixaService.FecharCaixaAsync(valorModal);
                if (sucesso)
                {
                    FecharModal();
                }
                else
                {
                    mensagemErro = "Erro ao fechar caixa";
                }
            }
            else
            {
                if (valorModal <= 0)
                {
                    mensagemErro = "Valor deve ser maior que zero";
                    return;
                }

                if (string.IsNullOrWhiteSpace(descricaoModal))
                {
                    mensagemErro = "Informe uma descri√ß√£o";
                    return;
                }

                await CaixaService.RegistrarMovimentoAsync(tipoModal, valorModal, descricaoModal);
                FecharModal();
            }
        }
        finally
        {
            processando = false;
        }
    }

    private void Sair()
    {
        AuthService.Logout();
        Navigation.NavigateTo("/", true);
    }

    public void Dispose()
    {
        CaixaService.OnCaixaChanged -= OnCaixaChanged;
    }
}
